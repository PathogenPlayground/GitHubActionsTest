name: Close milestone
on:
  workflow_dispatch:
    inputs:
      milstone:
        description: "Milestone"
        default: "1.2.3"
permissions:
      issues: write
jobs:
  close-milestone:
    runs-on: ubuntu-latest
    steps:
      - name: Close milestone
        uses: actions/github-script@v7
        with:
          user-agent: actions/github-script for ${{github.repository}}
          script: |
            core.info(JSON.stringify(context.payload));
            const milestoneToClose = context.payload.workflow_dispatch.inputs.milestone;

            milestones = github.issues.listMilestones({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100,
            });

            for (let milestone of milestones) {
              if (milestone.title != milestoneToClose) {
                continue;
              }

              core.info(`Closing milestone '${milestoneToClose}' #${milestone.number}...`);
              github.issues.updateMilestone({
                owner: context.repo.owner,
                repo: context.repo.repo,
                milestone_number: milestone.number,
                state: 'closed',
              });

              return;
            }

            core.warning(`Could not find any milestone associated with '${milestoneToClose}', the milestone for this release will not be closed.`)

    